<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">lib/parks/europapark/europapark.js | @alexvv13/tpapi</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Api to fetch themepark data, such as queues, operating hours etc"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@alexvv13/tpapi"><meta property="twitter:description" content="Api to fetch themepark data, such as queues, operating hours etc"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/AlexVV13/tp-api"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/configBase.js~ConfigBase.html">ConfigBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/entity.js~Entity.html">Entity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseConfig">parseConfig</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#parks">parks</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/parks/park.js~Park.html">Park</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#parks-efteling">parks/efteling</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/parks/efteling/efteling.js~Efteling.html">Efteling</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#parks-europapark">parks/europapark</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/parks/europapark/europapark.js~EuropaPark.html">EuropaPark</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#parks-walibi">parks/walibi</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/parks/walibi/walibiholland.js~WalibiHolland.html">WalibiHolland</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/parks/europapark/europapark.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import fetch from &apos;node-fetch&apos;;
import {Park} from &apos;../park.js&apos;;

import dotenv from &apos;dotenv&apos;;
dotenv.config();

/**
* EuropaPark Park Object
*/
export class EuropaPark extends Park {
  /**
  * Create a new EuropaPark Park object
  * @param {object} options
  */
  constructor(options = {}) {
    options.name = options.name || &apos;Europa-Park&apos;;
    options.timezone = options.timezone || &apos;Europe/Berlin&apos;;

    // Setting the parks entrance as latlon
    options.latitude = 48.266140769976715;
    options.longitude = 7.722050520358709;

    options.apiBase = options.apiBase || process.env.EUROPAPARK_APIBASE;
    options.credentials = options.credentials || process.env.EUROPAPARK_LOGINSTRING;
    options.loginurl = options.loginurl || process.env.EUROPAPARK_LOGIN;
    options.refresh = options.refresh || process.env.EUROPAPARK_REFRESH;

    options.languages = options.languages || process.env.LANGUAGES;

    options.langoptions = options.langoptions || `{&apos;en&apos;, &apos;de&apos;, &apos;fr&apos;}`;

    super(options);

    if (!this.config.apiBase) throw new Error(&apos;Missing Europa-Park apiBase!&apos;);
    if (!this.config.credentials) throw new Error(&apos;Missing Europa-Park credentials!&apos;);
    if (!this.config.loginurl) throw new Error(&apos;Missing Europa-Park Login URL!&apos;);
    if (!this.config.refresh) throw new Error(&apos;Missing Europa-Park Refresh URL!&apos;);
    if (!this.config.languages) {
      this.config.languages = &apos;en&apos;;
    };
  }

  // Load the Europapark poidata
  // const poidata = (&apos;./data/parks/europapark/europapark_pois.json&apos;)
  // const poimock = (&apos;./data/parks/europapark/europapark_poi_mock.json&apos;)

  /**
  * Login to EuropaPark API
  * NEVER call this method without calling refresh() or getPOIS()!
  * @return {string} EuropaPark refresh token
  */
  async loginEP() {
    return fetch(this.config.apiBase +
      this.config.loginurl,
    {
      method: &apos;POST&apos;,
      headers: {
        &apos;Content-Type&apos;: &apos;application/json&apos;,
      },
      body: this.config.credentials,
    },
    )
        .then((res) =&gt; res.json())
        .then((login) =&gt; {
          const refreshtoken = {&apos;refresh_token&apos;: login.refresh_token};
          return Promise.resolve(refreshtoken);
        });
  }

  /**
  * Refresh your just obtained ep token
  * Tokens are 6 hrs valid, however there&apos;s no point in just calling this function without queues or sth else
  * @return {string} EuropaPark JWT Token
  */
  async refreshEP() {
    return await this.loginEP().then((refreshtoken) =&gt; fetch(this.config.apiBase +
        this.config.refresh,
    {
      method: &apos;POST&apos;,
      headers: {
        &apos;Content-Type&apos;: &apos;application/json&apos;,
      },
      body: JSON.stringify(refreshtoken),
    },
    )
        .then((res) =&gt; res.json())
        .then((jwt) =&gt; {
          const jwttoken = &apos;Bearer &apos; + jwt.token;
          return Promise.resolve(jwttoken);
        }),
    );
  };

  /**
  * Get All POIS of EuropaPark
  * This data contains all the POIS in EuropaPark
  */
  async getPOIS() {
    const jwttoken = await this.refreshEP();

    return fetch(this.config.apiBase +
      `pois/${this.config.languages}`,
    {
      headers: {
        &apos;Content-Type&apos;: &apos;application/json&apos;,
        &apos;JWTAuthorization&apos;: jwttoken,
      },
    },
    )
        .then((res) =&gt; res.json())
        .then((rideData) =&gt; {
          const poi = {};
          const singleRider = &apos;false&apos;; // EP doesn&apos;t send these values
          let fastPass = &apos;false&apos;; // Set fastpass to false as default
          let isVirtQueue = &apos;false&apos;; // Default poi isn&apos;t a virtqueue
          rideData.pois.forEach((ride) =&gt; { // Data includes Rulantica, however, they&apos;re listed as slides, so not defining anything special here.
            if (ride.type === &apos;attraction&apos; &amp;&amp; ride.code !== null) { // Return rides and pois which haven&apos;t null
              if (ride.name.indexOf(&apos;Queue - &apos;) === 0) return; // Ignore the Queue Pointers
              if (ride.name.indexOf(&apos;VirtualLine: &apos;) === 0) { // So EP reports virtlane as seperate map pointer, they send it as a stand-alone POI, assign the VirtQueue tag here.
                fastPass = &apos;true&apos;;
                isVirtQueue = &apos;true&apos;;
              } else { // Yay, it&apos;s not a Virtline entry!
                fastPass = &apos;false&apos;;
                isVirtQueue = &apos;false&apos;;
              }
              let area = &apos;Germany&apos;; // Really, this is the strangest empire thing ever
              if (ride.areaId == 10) {
                area = &apos;Adventureland&apos;;
              } else if (ride.areaId == 11) {
                area = &apos;Kingdom of the Minimoys&apos;;
              } else if (ride.areaId == 12) {
                area = &apos;Germany&apos;;
              } else if (ride.areaId == 13) {
                area = &apos;England&apos;;
              } else if (ride.areaId == 14) {
                area = &apos;France&apos;;
              } else if (ride.areaId == 15) {
                area = &apos;Greece&apos;;
              } else if (ride.areaId == 17) {
                area = &apos;Netherlands&apos;;
              } else if (ride.areaId == 19) {
                area = &apos;Ireland&apos;;
              } else if (ride.areaId == 20) {
                area = &apos;Iceland&apos;;
              } else if (ride.areaId == 21) {
                area = &apos;Italy&apos;;
              } else if (ride.areaId == 22) {
                area = &apos;Luxembourg&apos;;
              } else if (ride.areaId == 23) {
                area = &apos;Austria&apos;;
              } else if (ride.areaId == 24) {
                area = &apos;Portugal&apos;;
              } else if (ride.areaId == 25) {
                area = &apos;Russia&apos;;
              } else if (ride.areaId == 26) {
                area = &apos;Switzerland&apos;;
              } else if (ride.areaId == 27) {
                area = &apos;Scandinavia&apos;;
              } else if (ride.areaId == 28) {
                area = &apos;Spain&apos;;
              }

              // EuropaPark actually provides some cool tags which I&apos;ll attach here.
              let producer = null;
              let opening = null;
              let capacity = null;
              let ridetime = null;
              let thcapacity = null;
              let gforce = null;
              let maxspeed = null;
              let height = null;

              if (ride.attributes) {
                Object.keys(ride.attributes).forEach((poiat) =&gt; {
                  if (ride.attributes[poiat].key === &apos;Producer&apos;) {
                    producer = ride.attributes[poiat].value;
                  } else if (ride.attributes[poiat].key === &apos;Opening&apos;) {
                    opening = ride.attributes[poiat].value;
                  } else if (ride.attributes[poiat].key === &apos;Capacity&apos;) {
                    capacity = ride.attributes[poiat].value;
                  } else if (ride.attributes[poiat].key === &apos;Driving Time&apos;) {
                    ridetime = ride.attributes[poiat].value;
                  } else if (ride.attributes[poiat].key === &apos;Theoretical Capacity&apos;) {
                    thcapacity = ride.attributes[poiat].value;
                  } else if (ride.attributes[poiat].key === &apos;Max Acceleration&apos;) {
                    gforce = ride.attributes[poiat].value;
                  } else if (ride.attributes[poiat].key === &apos;Max Speed&apos;) {
                    maxspeed = ride.attributes[poiat].value;
                  } else if (ride.attributes[poiat].key === &apos;Height&apos;) {
                    height = ride.attributes[poiat].value;
                  }
                });
              }

              // And some restrictions.
              let minHeight = null;
              let minHeightAdult = null;
              let minAge = null;
              let minAgeAdult = null;
              let maxHeight = null;
              if (ride.minHeight) {
                minHeight = ride.minHeight;
              };
              if (ride.minHeightAdult) {
                minHeightAdult = ride.minHeightAdult;
              };
              if (ride.minAge) {
                minAge = ride.minAge;
              };
              if (ride.minAgeAdult) {
                minAgeAdult = ride.minAgeAdult;
              };
              if (ride.maxHeight) {
                maxHeight = ride.maxHeight;
              }

              // Build the ride object
              poi[ride.code] = {
                name: ride.name,
                id: &apos;Europapark_&apos; + ride.code,
                waitTime: null,
                state: null,
                active: null,
                location: {
                  latitude: ride.latitude,
                  longitude: ride.longitude,
                },
                meta: {
                  area: area,
                  single_rider: singleRider,
                  fastPass: fastPass,
                  type: ride.type,
                  single_rider: &apos;false&apos;,
                  isVirtQueue: isVirtQueue,
                  tags: {
                    Producer: producer,
                    Capacity: capacity,
                    Opened: opening,
                    Duration: ridetime,
                    Theoretical_Capacity: thcapacity,
                    Max_GForce: gforce,
                    Max_Speed: maxspeed,
                    Height: height,
                  },
                  restrictions: {
                    minHeight: minHeight,
                    minHeightCompanion: minHeightAdult,
                    maxHeight: maxHeight,
                    minAge: minAge,
                    minAgeCompagnion: minAgeAdult,
                  },
                },
              };
            };
          });
          return Promise.resolve(poi);
        });
  };

  /**
  * Get All Queues of EuropaPark
  * This data contains all the Queues in EuropaPark, attached with pois above.
  */
  async getQueue() {
    const token = await this.refreshEP();
    const rideData = await this.getPOIS();

    return fetch(this.config.apiBase +
      `waitingtimes`,
    {
      method: &apos;GET&apos;,
      headers: {
        &apos;Content-Type&apos;: &apos;application/json&apos;,
        &apos;JWTAuthorization&apos;: token,
      },
    },
    )
        .then((res) =&gt; res.json())
        .then((poiData) =&gt; {
          const rides = [];
          poiData.waitingtimes.forEach((ridetime) =&gt; {
          // Declare default for rides that doesn&apos;t fetch right now
            let waitTime = null;
            let state = null;
            let active = null; // Accepting null as value, since some rides never will join the queue api because they simply never have a queue
            // However, setting &apos;0&apos; &amp; state will set the ride all day closed, which isn&apos;t true obviously

            if (ridetime.time &gt; 0 &amp;&amp; ridetime.time &lt; 91) {
              waitTime = ridetime.time;
              state = &apos;Operating&apos;;
              active = &apos;true&apos;;
            } else if (ridetime.time === 91) {
              waitTime = 91;
              state = &apos;Operating&apos;;
              active = &apos;true&apos;;
            } else if (ridetime.time === 333 || ridetime.time === 666 || ridetime.time === 777) {
              waitTime = 0;
              state = &apos;Closed&apos;;
              active = &apos;false&apos;;
            } else if (ridetime.status === 444 || ridetime.time === 555 || ridetime.time === 999) {
              waitTime = 0;
              state = &apos;Down&apos;;
              active = &apos;false&apos;;
            } else if (ridetime.time === 222) {
              waitTime = 0;
              state = &apos;Refurbishment&apos;;
              active = &apos;false&apos;;
            }

            if (rideData[ridetime.code]) { // Skip null variables
              rideData[ridetime.code].waitTime = waitTime;
              rideData[ridetime.code].state = state;
              rideData[ridetime.code].active = active;

              const rideobj = {
                name: rideData[ridetime.code].name,
                id: rideData[ridetime.code].id,
                waitTime: rideData[ridetime.code].waitTime,
                state: rideData[ridetime.code].state,
                active: rideData[ridetime.code].active,
                location: {
                  latitude: rideData[ridetime.code].location.latitude,
                  longitude: rideData[ridetime.code].location.longitude,
                },
                meta: {
                  type: rideData[ridetime.code].meta.type,
                  area: rideData[ridetime.code].meta.area,
                  isVirtQueue: rideData[ridetime.code].meta.isVirtQueue,
                  fastPass: rideData[ridetime.code].meta.fastPass,
                  single_rider: rideData[ridetime.code].meta.single_rider,
                  tags: rideData[ridetime.code].meta.tags,
                  restrictions: rideData[ridetime.code].meta.restrictions,
                },
              };
              rides.push(rideobj);
            }
          });
          return Promise.resolve(rides);
        });
  };

  /**
  * Get All Operating Hours of EuropaPark
  * This data contains all the Operating Hours in EuropaPark, fetched with currentyear.
  */
  async getOpHours() {
    const token = await this.refreshEP();

    return fetch(
        this.config.apiBase +
          `europapark/opentime/`,
        {
          method: &apos;GET&apos;,
          headers: {
            &apos;Content-Type&apos;: &apos;application/json&apos;,
            &apos;JWTAuthorization&apos;: token,
          },
        },
    )
        .then((res) =&gt; res.json())
        .then((json) =&gt; {
          const Calendar = [];
          // Execute Calendar stuff here
          return Promise.resolve(Calendar);
        });
  }
}

export default EuropaPark;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
